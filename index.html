<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Gradius-style Game</title>
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .bg-space {
        background-image: url("https://www.transparenttextures.com/patterns/stardust.png");
        background-size: cover;
        animation: scrollBg 20s linear infinite;
      }
      @keyframes scrollBg {
        from {
          background-position: 0 0;
        }
        to {
          background-position: -1000px 0;
        }
      }
      #barrier {
        transition: opacity 0.3s ease;
      }
      #leftStickArea::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
      }
      #shotButton:active {
        background: rgba(255, 80, 80, 0.8);
        transform: scale(1.1);
      }
    </style>
  </head>
  <body class="m-0 p-0 overflow-hidden bg-black" ontouchstart="">
    <script>
      document.addEventListener("gesturestart", (e) => e.preventDefault());
    </script>

    <!-- BGM -->
    <audio id="bgm" src="bgm/02 Start ~ Main BGM Lv 0.mp3" loop></audio>

    <!-- Âõ∫ÂÆöUI -->
    <div
      class="absolute top-4 left-4 text-white text-xl z-[999] pointer-events-none select-none"
    >
      <div id="score">Score: 0</div>
      <div id="life" class="mt-2">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div id="combo" class="mt-2 text-sm text-yellow-300"></div>
    </div>

    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div
      id="startScreen"
      class="fixed inset-0 bg-black text-white flex flex-col items-center justify-center z-50"
    >
      <h1 class="text-4xl font-bold mb-6">Gradius-style Game</h1>
      <p class="text-lg">Press Any Key to Start</p>
    </div>
    <!-- „Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
    <div
      id="gameArea"
      class="relative w-screen h-screen bg-space overflow-hidden"
    >
      <img
        id="player"
        src="img/player.png"
        class="absolute w-12 h-12 mix-blend-screen opacity-90"
      />
      <div
        id="barrier"
        class="absolute w-20 h-20 rounded-full border-4 border-blue-400 opacity-70 hidden z-[80] pointer-events-none"
      ></div>

      <!-- ‰ªÆÊÉ≥„Éë„ÉÉ„Éâ -->
      <div
        id="virtualControls"
        class="fixed inset-0 z-[100] pointer-events-none"
      >
        <div
          id="leftStickArea"
          class="absolute bottom-4 left-4 w-32 h-32 bg-white bg-opacity-10 rounded-full pointer-events-auto"
        ></div>
        <div
          id="shotButton"
          class="absolute bottom-4 right-4 w-20 h-20 bg-red-500 bg-opacity-60 rounded-full flex items-center justify-center text-white text-xl font-bold pointer-events-auto select-none"
        >
          üî´
        </div>
      </div>
    </div>

    <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº -->
    <div
      id="gameOverScreen"
      class="hidden fixed inset-0 bg-black bg-opacity-80 text-white flex flex-col items-center justify-center z-50"
    >
      <h1 class="text-3xl font-bold mb-4">Game Over!</h1>
      <div id="ranking" class="mb-6 text-left"></div>
      <button
        id="restartButton"
        class="bg-white text-black font-bold py-2 px-4 rounded"
      >
        Play Again
      </button>
    </div>

    <!-- ÂäπÊûúÈü≥ -->
    <audio id="shotSound" src="bgm/se_zushuun3.mp3"></audio>
    <audio
      id="hitSound"
      src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"
    ></audio>

    <script>
      /* ======== „Ç∞„É≠„Éº„Éê„É´ ======== */
      const gameArea = $("#gameArea"),
        player = $("#player"),
        scoreDisplay = $("#score"),
        lifeDisplay = $("#life"),
        comboDisplay = $("#combo");
      const shotSound = $("#shotSound")[0],
        hitSound = $("#hitSound")[0],
        bgm = document.getElementById("bgm");
      let bgmStarted = false,
        animationFrameId,
        enemySpawnInterval,
        bossFireInterval,
        gameState;

      $(document).on("keydown", () => {
        if (!bgmStarted) {
          bgm.volume = 0.6;
          bgm.play();
          bgmStarted = true;
          $("#startScreen").addClass("hidden");
          initializeGameState();
          startGame();
        }
      });
      function initializeGameState() {
        gameState = {
          playerX: 100,
          playerY: innerHeight / 2,
          playerSpeed: 5,
          bulletSpeed: 10,
          enemySpeed: 3,
          score: 0,
          life: 3,
          isGameOver: false,
          bullets: [],
          enemies: [],
          enemyBullets: [],
          bossBullets: [],
          keys: {},
          defeatedEnemies: 0,
          bossActive: false,
          boss: null,
          bossHp: 30,
          canShoot: true,
          combo: 0,
          comboTimer: null,
          barrier: false,
        };
      }
      function removeBarrier() {
        gameState.barrier = false;
        $("#barrier").addClass("hidden");
      }
      /* ======== ÂÖ•Âäõ„Éª„Ç∑„Éß„ÉÉ„Éà ======== */
      function shoot3Way(x, y) {
        [0, -2, 2].forEach((dy) => {
          const b = $("<div>")
            .addClass("absolute w-2 h-1 bg-yellow-300")
            .css({ left: x + 50, top: y + 20 })
            .data("dy", dy);
          gameArea.append(b);
          gameState.bullets.push(b);
        });
      }
      $(document).keydown((e) => (gameState.keys[e.key] = true));
      $(document).keyup((e) => (gameState.keys[e.key] = false));
      $(document).keydown((e) => {
        if (e.key === " " && gameState.canShoot && !gameState.isGameOver) {
          gameState.canShoot = false;
          shoot3Way(gameState.playerX, gameState.playerY);
          shotSound.currentTime = 0;
          shotSound.play();
          setTimeout(() => (gameState.canShoot = true), 200);
        }
      });

      /* ‰ªÆÊÉ≥„Éë„ÉÉ„Éâ */
      $(function () {
        $("#leftStickArea").on("touchstart touchmove", (e) => {
          const t = e.originalEvent.touches[0],
            c = $(e.currentTarget).offset(),
            dx = t.pageX - (c.left + 64),
            dy = t.pageY - (c.top + 64),
            th = 10;
          gameState.keys["ArrowUp"] = dy < -th;
          gameState.keys["ArrowDown"] = dy > th;
          gameState.keys["ArrowLeft"] = dx < -th;
          gameState.keys["ArrowRight"] = dx > th;
        });
        $("#leftStickArea").on("touchend", () => {
          gameState.keys = {};
        });
        $("#shotButton").on("touchstart", () => {
          if (gameState.canShoot && !gameState.isGameOver) {
            gameState.canShoot = false;
            shoot3Way(gameState.playerX, gameState.playerY);
            shotSound.currentTime = 0;
            shotSound.play();
            setTimeout(() => (gameState.canShoot = true), 200);
          }
        });
      });

      /* ======== Ë°ùÁ™ÅÂà§ÂÆö & „Éê„É™„Ç¢ ======== */
      function isColliding($a, $b) {
        if (!$a?.length || !$b?.length) return false;
        const a = $a[0].getBoundingClientRect(),
          b = $b[0].getBoundingClientRect();
        return (
          a.left < b.right &&
          a.right > b.left &&
          a.top < b.bottom &&
          a.bottom > b.top
        );
      }
      function tryActivateBarrier() {
        if (!gameState.barrier && Math.random() < 1 / 100) {
          gameState.barrier = true;
          $("#barrier")
            .removeClass("hidden")
            .css({ left: gameState.playerX - 12, top: gameState.playerY - 12 });
        }
      }

      /* ======== ÊïµÁîüÊàêÔºàLv1~3 „É©„É≥„ÉÄ„É†Ôºâ ======== */
      function spawnSmartEnemy() {
        const enemy = $("<img>")
            .attr("src", "img/enemy.png")
            .addClass("absolute w-10 h-10 mix-blend-screen opacity-90"),
          aiType = Math.floor(Math.random() * 3) + 1,
          startTop = Math.random() * (innerHeight - 60);
        enemy.css({ left: innerWidth, top: startTop });
        gameArea.append(enemy);
        gameState.enemies.push(enemy);

        /* ÊïµÂºæ */
        setTimeout(() => {
          if (!gameState.isGameOver && enemy.parent().length) {
            const eb = $("<div>")
              .addClass("absolute w-2 h-1 bg-pink-400")
              .css({
                left: enemy.position().left,
                top: enemy.position().top + 20,
              });
            gameArea.append(eb);
            gameState.enemyBullets.push(eb);
          }
        }, 300);

        let offset = 0,
          dir = 1;
        const mv = setInterval(() => {
          if (gameState.isGameOver || !enemy.parent().length) {
            clearInterval(mv);
            return;
          }
          let left = enemy.position().left - gameState.enemySpeed,
            top = enemy.position().top;
          if (aiType === 1) {
            offset += dir;
            if (offset > 20 || offset < -20) dir *= -1;
            top = startTop + offset;
          } else if (aiType === 2) {
            top += gameState.playerY < top ? -1.5 : 1.5;
          } else {
            const danger = gameState.bullets.some(
              (b) =>
                Math.abs(b.position().left - left) < 100 &&
                Math.abs(b.position().top - top) < 30
            );
            if (danger) top += top > 10 ? -2 : 2;
          }
          enemy.css({ left, left, top });
        }, 50);
      }
      /* ======== „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞ ======== */
      function updatePlayer() {
        const k = gameState.keys,
          s = gameState.playerSpeed;
        if (k["ArrowUp"] || k.w) gameState.playerY -= s;
        if (k["ArrowDown"] || k.s) gameState.playerY += s;
        if (k["ArrowLeft"] || k.a) gameState.playerX -= s;
        if (k["ArrowRight"] || k.d) gameState.playerX += s;
        gameState.playerX = Math.max(
          0,
          Math.min(innerWidth - 48, gameState.playerX)
        );
        gameState.playerY = Math.max(
          0,
          Math.min(innerHeight - 48, gameState.playerY)
        );
        player.css({ left: gameState.playerX, top: gameState.playerY });
        if (gameState.barrier)
          $("#barrier").css({
            left: gameState.playerX - 12,
            top: gameState.playerY - 12,
          });
      }

      /* ======== „É°„Ç§„É≥ÈñãÂßã ======== */
      function startGame() {
        player.css({ left: gameState.playerX, top: gameState.playerY });
        lifeDisplay.text("‚ù§Ô∏è".repeat(gameState.life));
        scoreDisplay.text("Score: 0");
        comboDisplay.text("");
        enemySpawnInterval = setInterval(() => {
          if (!gameState.isGameOver && !gameState.bossActive) spawnSmartEnemy();
        }, 400);

        const loop = () => {
          if (gameState.isGameOver) return;
          updatePlayer();
          if (!gameState.bossActive && gameState.defeatedEnemies >= 50)
            spawnBoss();

          /* Ëá™Ê©üÂºæ */
          for (let i = gameState.bullets.length - 1; i >= 0; i--) {
            const b = gameState.bullets[i],
              x = b.position().left + gameState.bulletSpeed,
              y = b.position().top + b.data("dy");
            b.css({ left: x, top: y });
            if (x > innerWidth || y < 0 || y > innerHeight) {
              b.remove();
              gameState.bullets.splice(i, 1);
            }
          }

          /* Êïµ„ÉªÂºæ„Éª„Éú„ÇπÂºæ Âá¶ÁêÜÔºà„Éê„É™„Ç¢Áµ±‰∏ÄÔºâ */
          processEnemies();
          processEnemyBullets();
          processBossBullets();
          processBossHit();
          animationFrameId = requestAnimationFrame(loop);
        };
        loop();
      }

      /* ======== Âá¶ÁêÜÈñ¢Êï∞ ======== */
      function processEnemies() {
        for (let i = gameState.enemies.length - 1; i >= 0; i--) {
          const e = gameState.enemies[i];
          if (!e.parent().length) {
            gameState.enemies.splice(i, 1);
            continue;
          }
          if (isColliding(player, e)) {
            gameState.barrier ? removeBarrier() : damagePlayer();
            e.remove();
            gameState.enemies.splice(i, 1);
            continue;
          }
          for (let j = gameState.bullets.length - 1; j >= 0; j--) {
            const b = gameState.bullets[j];
            if (isColliding(b, e)) {
              b.remove();
              gameState.bullets.splice(j, 1);
              e.remove();
              gameState.enemies.splice(i, 1);
              gameState.defeatedEnemies++;
              tryActivateBarrier();
              addComboScore();
              scoreDisplay.text(`Score: ${gameState.score}`);
              break;
            }
          }
        }
      }
      function processEnemyBullets() {
        for (let i = gameState.enemyBullets.length - 1; i >= 0; i--) {
          const b = gameState.enemyBullets[i],
            x = b.position().left - 6;
          b.css("left", x);
          if (isColliding(player, b)) {
            gameState.barrier ? removeBarrier() : damagePlayer();
            b.remove();
            gameState.enemyBullets.splice(i, 1);
            continue;
          }
          if (x < -10) {
            b.remove();
            gameState.enemyBullets.splice(i, 1);
          }
        }
      }
      function processBossBullets() {
        for (let i = gameState.bossBullets.length - 1; i >= 0; i--) {
          const b = gameState.bossBullets[i],
            x = b.position().left + b.data("vx"),
            y = b.position().top + b.data("vy");
          b.css({ left: x, top: y });
          if (isColliding(player, b)) {
            gameState.barrier ? removeBarrier() : damagePlayer();
            b.remove();
            gameState.bossBullets.splice(i, 1);
            continue;
          }
          if (x < -10 || y < 0 || y > innerHeight) {
            b.remove();
            gameState.bossBullets.splice(i, 1);
          }
        }
      }
      function processBossHit() {
        if (!gameState.bossActive) return;
        for (let i = gameState.bullets.length - 1; i >= 0; i--) {
          const b = gameState.bullets[i];
          if (isColliding(b, gameState.boss)) {
            b.remove();
            gameState.bullets.splice(i, 1);
            if (--gameState.bossHp <= 0) {
              clearInterval(bossFireInterval);
              gameState.boss.remove();
              gameState.bossActive = false;
              gameState.boss = null;
              gameState.defeatedEnemies = 0;
              gameState.score += 10000;
              scoreDisplay.text(`Score: ${gameState.score}`);
            }
          }
        }
      }
      function damagePlayer() {
        hitSound.play();
        if (--gameState.life <= 0) return gameOver();
        lifeDisplay.text("‚ù§Ô∏è".repeat(gameState.life));
      }
      /* ======== „Éú„ÇπÁîüÊàê & „Éõ„Éº„Éü„É≥„Ç∞Âºæ ======== */
      function spawnBoss() {
        const boss = $("<img>")
          .attr("src", "img/boss.png")
          .addClass("absolute w-32 h-32 mix-blend-screen opacity-90")
          .css({ left: innerWidth - 120, top: innerHeight / 2 - 64 });
        gameArea.append(boss);
        gameState.boss = boss;
        gameState.bossActive = true;
        gameState.bossHp = 30;
        bossFireInterval = setInterval(() => {
          if (!gameState.bossActive) return clearInterval(bossFireInterval);
          const fx = boss.position().left,
            fy = boss.position().top + 30;
          for (let i = 0; i < 5; i++) {
            const b = $("<div>")
              .addClass("absolute w-2 h-1 bg-purple-400")
              .css({ left: fx, top: fy });
            const dx = gameState.playerX - fx,
              dy = gameState.playerY - fy,
              len = Math.hypot(dx, dy) || 1;
            b.data("vx", (dx / len) * 4 + (Math.random() - 0.5) * 2).data(
              "vy",
              (dy / len) * 4 + (Math.random() - 0.5) * 2
            );
            gameArea.append(b);
            gameState.bossBullets.push(b);
          }
        }, 1000);
      }

      /* ======== „Ç≥„É≥„ÉúÂæóÁÇπ ======== */
      function addComboScore() {
        gameState.combo++;
        gameState.score += 100 + 20 * (gameState.combo - 1);
        comboDisplay.text(`Combo: ${gameState.combo} HIT!`);
        clearTimeout(gameState.comboTimer);
        gameState.comboTimer = setTimeout(() => {
          gameState.combo = 0;
          comboDisplay.text("");
        }, 2000);
      }

      /* ======== „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº & ÂÜç„Çπ„Çø„Éº„Éà ======== */
      function gameOver() {
        gameState.isGameOver = true;
        cancelAnimationFrame(animationFrameId);
        clearInterval(enemySpawnInterval);
        clearInterval(bossFireInterval);
        const scores = (JSON.parse(localStorage.getItem("highScores")) || [])
          .concat(gameState.score)
          .sort((a, b) => b - a)
          .slice(0, 10);
        localStorage.setItem("highScores", JSON.stringify(scores));
        $("#ranking").html(
          "<h2 class='text-xl font-bold mb-2'>Top 10 Scores</h2>" +
            scores.map((s, i) => `${i + 1}. ${s}`).join("<br>")
        );
        $("#gameOverScreen").removeClass("hidden");
      }
      $("#restartButton").on("click", () => {
        $("#gameOverScreen").addClass("hidden");
        $("#gameArea").find("div, img").not("#player").remove();
        initializeGameState();
        $("#barrier").addClass("hidden");
        $("#score").text("Score: 0");
        $("#life").text("‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è");
        $("#combo").text("");
        player.css({ left: gameState.playerX, top: gameState.playerY });
        startGame();
      });
    </script>
  </body>
</html>
